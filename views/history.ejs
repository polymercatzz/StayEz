<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History</title>
    <link rel="stylesheet" href="../css/history.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Afacad+Flux:wght@100..1000&family=Concert+One&family=DM+Serif+Text:ital@0;1&family=Exo+2:ital,wght@0,100..900;1,100..900&family=Hind+Mysuru:wght@300;400;500;600;700&family=Inconsolata:wght@200..900&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Itim&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Marcellus&family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=PT+Sans+Caption:wght@400;700&family=Signika+Negative:wght@300..700&family=Silkscreen:wght@400;700&display=swap"
        rel="stylesheet">
    
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <img src="../img/logo.jpeg" alt="" class="pic">
            <div class="stayEz">StayEz</div>
        </div>
        <div class="menu-toggle" id="menuToggle">☰</div>
        <ul class="nav-links" id="navLinks">
            <li><a href="/user/main">Home</a></li>
            <li><a href="/user/history" class="his">History</a></li>
            <li><a href="/user/payment">Payment</a></li>
            <li><a href="#footer">Contact</a></li>
            <li><a href="#"class="hidden">Wish list</a></li>
            <li><a href="#" class="hidden" onclick="openPopup()">Profile</a></li>
            <li><a href="main-regis.html"class="hidden">Log out</a></li>
            <li><a href="/user/fav"><img src="../img/heart.png" alt="" class="pic2"></a></li>
            <li><a href="#" onclick="openPopup()"><img src="../img/user.png" alt="" class="pic3"></a></li>        
        </ul>
    </nav>
    <section>

        <div class="box">
            <p class="text">History</p>
        </div>

        <section class="history">
            <% history.forEach((item, index) => { %>
                <div class="all">
                    <div class="card">
                        <a href="/user/room-details/<%= item.room_id %>" class="card-link">
                            <p class="badge"><%= item.department_name %></p>
                            <img src="/room_img/<%= history[index].room_img_id %>" alt="Room Image" class="card-img">
                            <p class="card-title">รีวิว 4.9</p>
                            <p class="card-title"><%= item.price %> บาท/เดือน</p>
                            <p class="card-title"><%= item.bedroom %> ห้องนอน</p>
                            <div class="service">
                                <img src="../img/dog.png" alt="" class="pic4">
                                <img src="../img/gym.png" alt="" class="pic4">
                                <img src="../img/wifi.png" alt="" class="pic4">
                            </div>
                        </a>
                    </div>
                    <div class="alldata">
                        <div class="data">
                            <p class="card-title2"><%= item.history_date %></p>
                        </div>
                        <div class="data5">
                            <p class="card-title2">สถานะ: </p>
                            
                            <% let status = "สำเร็จ"; %>
                            <% if (item.history_status == "verification") { %>
                                <% status = "กำลังรอตรวจสอบ"; %>
                            <% } %>
                            <p class="card-title2"><%= status %></p>
                        </div>
                        <div class="data">
                            <p class="card-title2">รายละเอียดการเข้าพัก</p>
                        </div>
                        <div class="data5">
                            <p class="card-title2">หมายเลขห้อง: </p>
                            <p class="card-title2"><%= item.room_name %></p>
                        </div>
                        <div class="data5">
                            <p class="card-title2">สัญญาเช่าอยู่: </p>
                            <p class="card-title2"><%= item.tenancy %></p>
                        </div>
                        <div class="data5">
                            <p class="card-title2">จำนวนผู้เข้าพัก: </p>
                            <p class="card-title2"><%= item.people %> คน</p>
                        </div>
                        <div class="data5">
                            <p class="card-title2">วันที่เริ่มทำสัญญา: </p>
                            <p class="card-title2"><%= item.history_date %></p>
                        </div>
                        <div class="data3">
                            <a href="/user/showcontract/<%= item.contract_id %>" class="book">หนังสือสัญญา</a>
                            <button class="cancel" onclick="openPopup2(<%= item.history_id %>, <%= item.room_id %>)">ยกเลิกสัญญา</button>
                            <a href="#" class="review" onclick="openPopup3('<%= item.room_id %>')">Review</a>
                        </div>
                    </div>
                </div>
                <% }); %>
        </section>
        <!-- popup profile -->
        <div class="overlay" id="overlay" onclick="closePopup()"></div>
        <section>
            <div class="popup" id="popup">
                <div class="profile" >
                    <div class="close-btn">
                        <button onclick="closePopup()">
                            <img src="../img/close.png" alt="">
                        </button>
                    </div>
                    <p>Profile</p>
                    <div class="allpopupdata">
                        <div class="popupdata">
                            <label for="name">Name:</label>
                            <input type="text" id="firstname" value="<%= user.first_name %>" readonly>
                        </div>
                        <div class="popupdata">
                            <label for="lastname">Lastname:</label>
                            <input type="text" id="lastname" value="<%= user.last_name %>" readonly>
                        </div>
                        <div class="popupdata">
                            <label for="tel">Tel:</label>
                            <input type="text" id="tel" value="<%= user.tel %>" readonly>
                        </div>
                        <div class="popupdata">
                            <label for="email">Email:</label>
                            <input type="text" id="email" value="<%= user.email %>" readonly>
                        </div>
                        <div class="log-out">
                            <br>
    
                            <a href="/logout"><button><img src="../img/log-out.png" alt=""></button></a>
                        </div>
                    </div>
                    
                </div>
            </div>
    
        </section>
        <!-- popup cancel -->
        <div class="overlay2" id="overlay2" onclick="closePopup2()"></div>

        <section>
            <div class="pop-upcancel" id="pop-upcancel">
                <div class="close-btn">
                    <button onclick="closePopup2()">
                        <img src="../img/close.png" alt="">
                    </button>
                </div>
                <div class="ok">
                    <form id="cancel_history" method="post">
                        <p>ยืนยันการยกเลิก</p>
                        <button onclick="closePopup2()" class="but" type="submit">ยืนยัน</button>
                    </form>
                </div>
            </div>

            <div class="overlay" id="overlay" onclick="closePopup3()"></div>

            <section>
                <div class="popup-review" id="popup-review">
                    <div class="close-btn">
                        <button onclick="closePopup3()">
                            <img src="../img/close.png" alt="">
                        </button>
                    </div>
                    <p>Review</p>
                    <div class="allreviewdata">
                        <div class="reviewdata">
                            <label for="rate">Rate:</label>
                            <select id="rate">
                                <option value="5">5</option>
                                <option value="4">4</option>
                                <option value="3">3</option>
                                <option value="2">2</option>
                                <option value="1">1</option>
                            </select>
                        </div>
                        <div class="reviewdata">
                            <label for="review">Review:</label>
                            <textarea id="review" rows="4" cols="30"></textarea>
                        </div>
                        <button onclick="submitReview()" class="submit">Submit</button>
                    </div>
                </div>
            </section>


            <footer id="footer">
                <div class="footer">
                    <div class="footer-content">
                        <p>Line: @place1234</p>
                        <p>Tel: 000000000</p>
                        <p>Email: place@1234.com</p>
                    </div>
            </footer>


















            <input type="hidden" id="userId" value="<%= user.user_id %>">
            <input type="hidden" id="roomId" value="">
            <script>
                // menu
                document.getElementById("menuToggle").addEventListener("click", function () {
                    document.getElementById("navLinks").classList.toggle("active");
                });

                document.querySelectorAll(".dropdown-toggle").forEach(item => {
                    item.addEventListener("click", function () {
                        let dropdownMenu = this.nextElementSibling;
                        dropdownMenu.classList.toggle("show");
                    });
                });

                document.addEventListener("click", function (event) {
                    if (!event.target.closest(".navbar")) {
                        document.getElementById("navLinks").classList.remove("active");
                        document.querySelectorAll(".dropdown-menu").forEach(menu => menu.classList.remove("show"));
                    }
                });

                // popup
                let popup = document.getElementById("popup");

                async function submitReview() {
                    const userId = document.getElementById("userId").value;
                    const roomId = document.getElementById("roomId").value;

                    const rate = document.getElementById("rate").value;
                    const review = document.getElementById("review").value;

                    if (!rate || !review.trim()) {
                        alert("Please provide a rating and a review.");
                        return;
                    }

                    // window.location.href = `/user/history`;

                    fetch(`/user/review/${userId}/${roomId}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            rate: rate,
                            review: review,
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Success:", data);
                        closePopup3();
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
                }

                function openPopup() {
                    popup.classList.add("openPopup");
                    document.getElementById("overlay").classList.add("active");


                }

                function closePopup() {
                    popup.classList.remove("openPopup");
                    document.getElementById("overlay").classList.remove("active");

                }
                // cancel
                function openPopup2(history_id, room_id) {
                    document.getElementById("pop-upcancel").classList.add("active");
                    document.getElementById("overlay2").classList.add("active");
                    document.getElementById("cancel_history").action = `/user/cancel_history/${history_id}/${room_id}`
                }

                document.getElementById("cancel_history").addEventListener("submit", function(event) {
                    event.preventDefault();
                    const formAction = document.getElementById("cancel_history").action;

                    fetch(formAction, {
                        method: "POST",
                    })
                    .then(response => response.json())
                    .then(data => {
                        Swal.fire({
                            title: "ยกเลิกสำเร็จ!",
                            text: "การจองห้องพักของคุณถูกยกเลิกาสำเร็จแล้ว",
                            icon: "success",
                            confirmButtonText: "ตกลง"
                        }).then(() => {
                            closePopup2();
                            window.location.reload();
                        });
                    })
                    .catch(error => {
                        console.log("Error:", error);
                        Swal.fire("Error", "Something went wrong. Please try again.", "error");
                    });
                });

                function closePopup2() {
                    document.getElementById("pop-upcancel").classList.remove("active");
                    document.getElementById("overlay2").classList.remove("active");
                }
                // popup review
                function openPopup3(roomId) {
                    document.getElementById("popup-review").classList.add("active");
                    document.getElementById("overlay").classList.add("active");

                    document.getElementById("roomId").value = roomId;
                }

                function closePopup3() {
                    document.getElementById("popup-review").classList.remove("active");
                    document.getElementById("overlay").classList.remove("active");
                }
            </script>
</body>

</html>